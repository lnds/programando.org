// jquery-turtle.googlecode.com v0.6 Copyright(c) 2011 David Bau, MIT license
(function(g){function F(a){window[a]=null;return function(e){window[a]=e}}function x(a){for(var e,b=["transform","WebkitTransform","msTransform","MozTransform","OTransform"];e=b.shift();)if(e in a.style)return e;return"transform"}function w(a){q===null&&(q=x(a));return a.style[q]}function v(a){return(a=(a=w(a))&&a.match(/rotate\(([^)]+)\)/))&&a[1]?parseFloat(a[1]):0}function r(a,e){var b=w(a).replace(/none|rotate\([^)]*\)/,"")+"rotate("+e+"deg)";q===null&&(q=x(a));a.style[q]=b}function z(){var a=g(window),e=Math.max(1500,a.width()),a=Math.max(1500,a.height()),b=m.height;if(m.width!=e||b!=a)b=document.createElement("canvas"),b.width=Math.max(m.width,e),b.height=Math.max(m.height,a),b.getContext("2d").drawImage(m,0,0),m.width=e,m.height=a,m.getContext("2d").drawImage(b,0,0)}function y(){if(!h){var a=document.createElement("div");m=document.createElement("canvas");a.style.position=m.style.position="absolute";a.style.top=a.style.left=m.style.top=m.style.left=0;a.style.zIndex=m.style.zIndex=-1;a.style.width=a.style.height="100%";a.style.overflow="hidden";z();document.body.appendChild(a);a.appendChild(m);h=m.getContext("2d");g(window).resize(z)}}function G(a,e,b){var c;y();h.lineWidth=1.62;h.strokeStyle="#000000";h.lineCap="round";if(g.isPlainObject(b))for(c in b)h[c]=b[c];h.beginPath();h.moveTo(a.pageX,a.pageY);h.lineTo(e.pageX,e.pageY);h.stroke()}function s(a){return typeof a=="number"?true:typeof a=="string"&&a.match(/^\d/)?true:false}function t(a){return a&&a.hasOwnProperty("pageX")&&a.hasOwnProperty("pageY")}function A(a,e,b){if(b>180)return e;if(b<=0)return a;var c=(e-a)%360;c<=-180?c+=360:c>180&&(c-=360);c>b?e=(a+b)%360:c<-b?e=(a+360-b)%360:e%=360;e<0&&(e+=360);return e}function B(a,e,b){if(b<=0)return a;var c=e.pageX-a.pageX,d=e.pageY-a.pageY,f=c*c+d*d;if(b*b>=f)return e;e=b/Math.sqrt(f);return{pageX:a.pageX+e*c,pageY:a.pageY+e*d}}function C(a,e,b){return Math.abs(a.pageX-e)<1&&Math.abs(a.pageY-b)<1?{pageX:e,pageY:b}:a}function H(a,e,b,c){var d=g.css(a,"position");if(d==="static")a.style.position="relative";var f=e.offset(),i=e.parent(),j=i.direction(),i=i.mirror()?-1:1,o=g.css(a,"top"),l=g.css(a,"left"),k={},u={};(d==="absolute"||d==="fixed")&&g.inArray("auto",[o,l])>-1?(u=e.position(),d=u.top,l=u.left):(d=parseFloat(o)||0,l=parseFloat(l)||0);jQuery.isFunction(b)&&(b=b.call(a,c,f));if(j==0&&!i){if(b.top!=null)k.top=b.top-f.top+d;if(b.left!=null)k.left=b.left-f.left+l}else j=j*Math.PI/180,c=Math.cos(j),j=Math.sin(j),o=u=0,b.top!=null&&(o=b.top-f.top),b.left!=null&&(u=b.left-f.left),k.top=d+o*c-u*j,k.left=l+i*(u*c+o*j);"using"in b?b.using.call(a,k):e.css(k)}function D(a){a=a.match(/scaleX\(([^)]+)\)/);return!(!a||!(a[1]&&a[1]<0))}function E(a){var e=g(a),a=e.center(),b=e.width()/2,c=e.height()/2,e=e.direction()*Math.PI/180,d=Math.cos(e),f=Math.sin(e),e=c*d,c=-c*f;d*=b;b*=f;return!t(a)?[]:[{pageX:a.pageX-c-d,pageY:a.pageY-e-b},{pageX:a.pageX-c+d,pageY:a.pageY-e+b},{pageX:a.pageX+c+d,pageY:a.pageY+e+b},{pageX:a.pageX+c-d,pageY:a.pageY+e-b}]}g.setupids=function(a){a=a||"";g("[id]").each(function(e,b){window[a+b.id]=g("#"+b.id)})};g.setupevents=function(a){var a=a||"",e="click,mouseup,mousedown,mousemove,keydown,keypress,keyup".split(","),b;for(b=0;b<e.length;++b)g(window).bind(e[b],F(a+e[b]))};var m=null,h=null,q=null;g.fn.turn=function(a){typeof a=="undefined"?this.each(function(a,b){r(b,Math.random()*360)}):this.each(function(e,b){var c=g(b).mirror()?-1:1,c=(v(b)+a*c)%360;c<0&&(c+=360);r(b,c)});return this};g.fn.move=function(a){typeof a=="undefined"?this.each(function(a,b){var c=g(b),d=c.parent(),f=d.width(),i=d.height(),f=Math.random()*f-f/2,j=Math.random()*i-i/2,i=d.direction()*Math.PI/180,o=Math.cos(i),l=Math.sin(i),i=f*o-j*l,f=j*o+f*l,d=d.center();c.moveto({pageX:d.pageX+i,pageY:d.pageY+f})}):this.each(function(e,b){var c=g(b),d=c.center();if(d){var f=c.direction()*Math.PI/180,i=Math.cos(f),f=Math.sin(f)*a;c.moveto({pageX:d.pageX+f,pageY:d.pageY+-i*a})}});return this};g.fn.turnto=function(a,e){if(s(a))a=parseFloat(a),this.each(function(b,c){var d=g(c),f=(typeof e!="number"?a:A(d.direction(),a,e))-d.parent().direction(),d=(d.mirror()?360-f:f)%360;r(c,d<0?d+360:d)});else{if(!a)return this;t(a)||(a=g(a).center());if(!a)return this;if(!t(a))return;this.each(function(b,c){var d=g(c),f=d.center();f&&(f=Math.atan2(a.pageY-f.pageY,a.pageX-f.pageX)/Math.PI*180+90,typeof e=="number"&&(f=A(d.direction(),f,e)),f-=d.parent().direction(),f=(d.mirror()?360-f:f)%360,f<0&&(f+=360),r(c,f))})}return this};g.fn.moveto=function(a,e){s(a)&&s(e)&&(a={pageX:parseFloat(a),pageY:parseFloat(e)},e=null);if(!a)return this;if(!a.hasOwnProperty("pageX")||!a.hasOwnProperty("pageY"))a=g(a).center();if(!a||!a.hasOwnProperty("pageX")||!a.hasOwnProperty("pageY"))return this;this.each(function(b,c){var d=g(c),f,i,j,o;if(g.isWindow(c)){f=a.pageX;i=a.pageY;j=d.width();o=d.height();var l=g("body").width(),k=g("body").height();f>l-j/2&&(f=l-j/2);f<j/2&&(f=j/2);i>k-o/2&&(i=k-o/2);i<o/2&&(i=o/2);i={pageX:f,pageY:i};typeof e=="number"&&(i=B(d.center(),i,e));d.scrollLeft(i.pageX-d.width()/2);d.scrollTop(i.pageY-d.height()/2);d.data("cx",i.pageX);d.data("cy",i.pageY)}else c.tagName=="IMG"&&!c.complete&&!d.data("cp")&&(d.data("cp",1),g(c).load(function(){if(d.data("cx")&&d.data("cy")){var a=d.data("pendown");a&&d.removeData("pendown");d.moveto(d.data("cx"),d.data("cy"));a&&d.data("pendown",a)}})),(f=c.nodeType!=1||d.css("display")!="none")||d.show(),(j=v(c))&&r(c,0),i=a,o=d.center(),typeof e=="number"&&(i=B(d.center(),a,e)),H(c,d,{left:Math.round(i.pageX-d.width()/2),top:Math.round(i.pageY-d.height()/2)},b),j&&r(c,j),f||d.hide(),d.data("cx",i.pageX),d.data("cy",i.pageY),d.data("pendown")&&G(o,i,d.data("penstyle"))});return this};g.fn.mirror=function(a){if(typeof a=="undefined")return this.length==0||g.isWindow(this[0])||this[0].nodeType==9?false:!D(w(this[0]))==this.parent().mirror();this.each(function(e,b){item=g(b);var c=!a==item.parent().mirror(),d=w(item[0])||"none",f=D(d),i=item[0],d=(c?" scaleX(-1) ":"")+d.replace(/none|scaleX\([^)]*\)/,"");q===null&&(q=x(i));i.style[q]=d;c==!f&&v(b)&&r(b,360-v(b))});return this};g.fn.center=function(){if(!this.length)return null;var a=this[0],e=this.data("cx"),b=this.data("cy"),c;if(g.isWindow(a))return C({pageX:this.width()/2+this.scrollLeft(),pageY:this.height()/2+this.scrollTop()},e,b);else if(a.nodeType===9)return{pageX:this.width()/2,pageY:this.height()/2};(c=a.nodeType!=1||this.css("display")!="none")||this.eq(0).show();var d=v(a);d&&r(a,0);var f=this.offset(),f={pageX:f.left+this.width()/2,pageY:f.top+this.height()/2};d&&r(a,d);c||this.eq(0).hide();return C(f,e,b)};g.fn.direction=function(){if(!this.length)return null;var a=this[0];if(g.isWindow(a)||a.nodeType==9)return 0;a=v(a)*(this.mirror()?-1:1)+this.parent().direction()%360;a<0&&(a+=360);return a};g.fn.encloses=function(a,e){function b(a){var b=a.pageX-o,a=a.pageY-l,c=a*d-b*f;return Math.abs(b*d+a*f)<=i&&Math.abs(c)<=j}if(!this.is(":visible"))return false;s(a)&&s(e)&&(a={pageX:a,pageY:e});var c=this.direction()*Math.PI/180,d=Math.cos(c),f=Math.sin(c),i=this.width()/2,j=this.height()/2,c=this.center(),o=c.pageX,l=c.pageY,k=c=0,h,p;for(g.isArray(a)||(a=t(a)?[a]:g(a));c<a.length;c+=1){h=a[c];if(t(h)){if(!b(h))return false}else{if(!h)continue;p=E(h);for(h=0;h<p.length;h+=1)if(!b(p[h]))return false}k+=1}return k>0};g.fn.touches=function(a,e){var b,c,d,f;if(!this.is(":visible"))return false;s(a)&&s(e)&&(a={pageX:a,pageY:e});g.isArray(a)||(a=t(a)?[a]:g(a));var i=this.center(),j,h,l,k,m,p,n,q;if(!i)return false;for(m=0;m<a.length;m+=1)if(f=a[m],t(f)){if(this.encloses(f))return true}else if(item=g(f),item.is(":visible")){ang2=item.direction()*Math.PI/180;f=Math.cos(ang2);b=Math.sin(ang2);c=this.direction()*Math.PI/180-ang2;j=Math.cos(c);h=Math.sin(c);c=item.center();c.pageX-=i.pageX;c.pageY-=i.pageY;n=c.pageX;c.pageX=(n*f+c.pageY*b)*2;c.pageY=(-n*b+c.pageY*f)*2;d=c.pageX+item.width();f=c.pageY+item.height();b=c.pageX-item.width();c=c.pageY-item.height();p=this.width()*h;n=this.width()*j;k=this.height()*h;q=this.height()*j;l={pageX:-k+n,pageY:q+p};k={pageX:-k-n,pageY:q-p};n=h*j;n<0&&(p=l,l=k,k=p);if(h<0)k.pageX=-k.pageX,k.pageY=-k.pageY;if(!(k.pageX>d||-k.pageX<b))if(n==0?(p=l.pageY,b=-p):(n=l.pageX,j=b-n,h=d-n,p=l.pageY,h*j>0&&(j<0?(n-=k.pageX,p-=k.pageY,j=h):(n+=k.pageX,p+=k.pageY),p=p*j/n+l.pageY),n=-l.pageX,j=b-n,h=d-n,b=-l.pageY,h*j>0&&(j<0?(n-=k.pageX,b-=k.pageY,j=h):(n+=k.pageX,b+=k.pageY),b=b*j/n-l.pageY)),!(p<c&&b<c)&&!(p>f&&b>f))return true}return false};g.fn.pen=function(a){typeof a=="undefined"?a=true:a=="none"&&(a=false,this.removeData("penstyle"));typeof a=="string"&&(a={strokeStyle:a});this.data("pendown",!!a);g.isPlainObject(a)&&this.data("penstyle",a);return this};g.fn.dot=function(a,e){if(typeof a=="undefined")a="#000000";else if(a=="none"||!a)a="#ffffff";typeof a=="string"&&(a={fillStyle:a});typeof e=="undefined"&&(e=1);y();if(g.isPlainObject(a))for(var b in a)h[b]=a[b];this.each(function(a,b){var f=g(b).center();h.beginPath();h.arc(f.pageX,f.pageY,e/2,0,2*Math.PI,false);h.closePath();h.fill()});return this};g.fn.erase=function(a){typeof a=="undefined"&&(a="rgba(0,0,0,0)");typeof a=="string"&&(a={fillStyle:a});y();if(g.isPlainObject(a))for(var e in a)h[e]=a[e];this.each(function(a,c){var d=E(c===document?m:c);if(d&&!(d.length<3)){h.beginPath();h.moveTo(d[0].pageX,d[0].pageY);for(a=1;a<d.length;a+=1)h.lineTo(d[a].pageX,d[a].pageY);h.closePath();d=h.globalCompositeOperation;h.globalCompositeOperation="copy";h.fill();h.globalCompositeOperation=d}});return this};g.fn.replay=function(){this.each(function(a,e){if(e.src){var b=e.src;e.src="";e.src=b}});return this};g.fn.shown=function(){return this.is(":visible")};g.fn.hidden=function(){return this.is(":hidden")};g.fn.todo=function(a){this.each(function(e,b){var c=g(b),d=c.center(),f=c.direction(),i=c.data("pendown"),h=c.data("penstyle");c.delay(0).queue(function(b){c.removeData("pendown").removeData("penstyle").moveto(d).turnto(f);i&&c.data("pendown",i);h&&c.data("penstyle",h);a.call(c);b()})})}})(jQuery);
